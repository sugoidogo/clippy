<iframe></iframe>
<style>
    * {
        width: 100%;
        height: 100%;
        margin: 0px;
    }
</style>
<script>
    let pass, login, commands, irc, mods, client_id, intervalID, delay;
    const iframe=document.getElementsByTagName('iframe')[0]

    function send(message){
        console.log('< '+message);
        irc.send(message);
    }

    function getMods(){
        send('PRIVMSG #'+login+' :/mods')
    }

    function clearFrame(){
        iframe.src='';
    }

    function getAuthHeaders(){
        return {
            'Authorization':'Bearer '+pass
            ,'Client-Id':client_id
        }
    }

    async function getBroadcasterId(target){
        target=target.toLowerCase();
        const response=await fetch('https://api.twitch.tv/helix/users'
            +'?login='+target
            ,{
                headers:getAuthHeaders()
            }
        )
        const json=await response.json()
        return json['data'][0]['id']
    }

    async function shoutout(target){
        console.log("! shoutout:"+target);
        target=await getBroadcasterId(target);
        const response=await fetch('https://api.twitch.tv/helix/clips'
            +'?broadcaster_id='+target
            +'&first=100'
            ,{
                headers:getAuthHeaders()
            }
        )
        const json=await response.json();
        const max=json['data'].length;
        console.log(json);
        const index=Math.floor(Math.random() * max);
        const URL=json['data'][index]['embed_url']+'&autoplay=true&parent='+window.location.hostname;
        const duration=json['data'][index]['duration']*1000;
        iframe.src=URL
        setTimeout(clearFrame,duration+delay);
    }

    function onopen(event){
        send('PASS oauth:'+pass)
        send('NICK '+login)
        send('JOIN #'+login)
        send('CAP REQ :twitch.tv/commands')
        intervalID=setInterval(getMods,1000)
    }

    function onmessage(event){
        const message=event.data;
        console.log('> '+message)
        for (const line of message.split('\n')){

            if(line.startsWith('PING')){
                send('PONG'+line.substring(4))
                continue;
            }

            if(line.includes('The moderators of this channel are:')){
                mods=line.substring(line.lastIndexOf(':')+1).replaceAll(' ','').split(',');
                mods.unshift(login);
                console.log('! mods list updated ('+mods.length+'):'+mods);
                continue;
            }

            for (const command of commands){
                if(line.includes(command)){
                    const target=line.substring(line.lastIndexOf(command)+command.length).trim();
                    shoutout(target);
                }
            }
        }
    }

    function onerror(event){
        clearInterval(intervalID);
        try{
            init();
            return;
        } catch (e) {
            console.error(event)
            console.error('when attempting to reconnect, another error occured')
            console.error(e)
        } finally {
            throw event
        }
    }

    function init(){
        const params=new URLSearchParams(document.location.search);
        pass=params.get('pass');
        login=params.get('login');
        client_id=params.get('client_id');
        commands=params.get('commands').split(',');
        delay=parseInt(params.get('delay'))*1000;
        commands.pop();
        console.log('! commands ('+commands.length+'): '+commands);
        const ircwsurl=params.get('ircwsurl') || 'wss://irc-ws.chat.twitch.tv:443'
        irc=new WebSocket(ircwsurl);
        irc.onopen=onopen;
        irc.onmessage=onmessage;
        irc.onerror=onerror;
        irc.onclose=onerror;
    }

    try{
        init();
    }catch (e){
        alert(e);
        throw e;
    }

</script>