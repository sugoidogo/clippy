<body>
    <header>
        <img hidden>
        <h1 hidden></h1>
    </header>
    <video autoplay></video>
    <footer><h2 hidden></h2></footer>
</body>
<style>
    body {
        overflow: hidden;
        margin: 0px;
        opacity: 0;
    }
    header{
        position: absolute;
        top: 0px;
        left: 0px;
        right: 0px;
    }
    footer{
        position: absolute;
        bottom: 0px;
        left: 0px;
        right: 0px;
    }
    header,footer{
        display: flex;
        align-items: center;
    }
    h1,h2 {
        font-size: 10vh;
        margin-block-start: 0px;
        margin-block-end: 0px;
        white-space: nowrap;
    }
    img{
        height: 10vh;
        border-radius: 50%;
        display: inline;
    }
    video {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.js" 
    integrity="sha256-6fEA3uF0XCtisIcFZy5HTT58XocXY7LX7JUfEiK6W5Y=" 
    crossorigin="anonymous">
</script>
<script type="module">
    const config_name=new URLSearchParams(location.search).get('name')
    const localStorage=localforage.createInstance({name:'clippy.v2'})
    const video=document.querySelector('video')
    const img=document.querySelector('img')
    const header=document.querySelector('h1')
    const footer=document.querySelector('h2')
    const body=document.querySelector('body')
    const maxFontSize=parseInt(getComputedStyle(header).fontSize)
    const auth_headers={}
    const queue=[]
    let mods=[]
    let cut=undefined
    let config=undefined
    let irc=undefined
    let broadcaster=undefined
    import fontScale from '../js-util/fontScale.mjs'
    import loadAsset from '../js-util/AssetLoader.mjs'
    import FileReaderAsync from '../js-util/FileReaderAsync.mjs'
    // fill variables in a string using bash variable notation
    function fillVars(string,vars,prefix='$'){
        for(const [key,val] of Object.entries(vars)){
            string=string.replaceAll(prefix+key,val)
        }
        return string
    }
    // load the next clip from the queue
    async function loadNextClip(){
        const clip=queue.shift()
        console.debug(clip)
        if('headerImg' in config){
            img.src=clip.profile_image_url
        }
        if('header' in config){
            header.innerHTML=fillVars(config.headerText,clip)
            await fontScale(header,maxFontSize)
        }
        if('footer' in config){
            footer.innerHTML=fillVars(config.footerText,clip)
            await fontScale(footer,maxFontSize)
        }
        video.src=clip.video_url
    }
    // apply a clip filter
    function applyFilter(filter,clips,target){
        //TODO
        return clips
    }
    // send a raw irc message
    window.IRCSend=function(message){
        console.debug('< '+message)
        irc.send(message)
    }
    // send a chat message in the broadcaster's channel
    window.IRCSendChat=function(message){
        IRCSend('PRIVMSG #' + broadcaster.login + ' :' + message)
    }
    // play one or more clips from one or more twitch channels
    window.shoutout=async function(...targets){
        console.debug('shoutout',targets)
        for(let target of targets){
            if(target[0]==='@'){
                target=target.substring(1)
            }
            target=target.toLowerCase()
            const url=new URL('https://api.twitch.tv/helix/users')
            url.search=new URLSearchParams({
                'login':target
            })
            return fetch(url,{headers:auth_headers})
            .then(async function(response){
                const json=await response.json()
                target=json.data[0]
                if('message' in config){
                    IRCSendChat(fillVars(config.messageText,target))
                }
                const url=new URL('https://api.twitch.tv/helix/clips')
                url.search=new URLSearchParams({
                    'broadcaster_id':target.id,
                    'first':config.first
                })
                return fetch(url,{headers:auth_headers})
            })
            .then(async function(response){
                const json=await response.json()
                let clips=json.data
                if('filters' in config){
                    for(const filter of config.filters){
                        clips=applyFilter(filter,clips,target)
                    }
                }
                for(const clip of clips){
                    clip.profile_image_url=target.profile_image_url
                    clip.video_url=clip.thumbnail_url.replace(/-preview-.*/g,'.mp4')
                }
                queue.push(...clips)
                if(video.src==''){
                    loadNextClip()
                }
                return clips
            })
        }
    }
    video.onended=function(){
        video.src=''
        body.style.opacity=0
        try {
            loadNextClip()
        } catch {
            if('auto' in config){
                shoutout(broadcaster.login)
            }
        }
    }
    video.onplay=function(){
        body.style.opacity=1
        if(cut!==undefined){
            setTimeout(video.onended)
        }
    }
    // read config
    config=await localStorage.getItem(config_name)
    if(config===undefined){
        config=JSON.parse(decodeURIComponent(location.hash.substring(1)))
        localStorage.setItem(config_name,config)
    }
    // read access_token after returning from js-util/auth-return
    config.access_token=new URLSearchParams(location.hash.substring(1)).get('access_token') || config.access_token
    console.debug(config)
    // verify access_token
    fetch('https://id.twitch.tv/oauth2/validate',{headers:{'Authorization':'OAuth '+config.access_token}})
    // populate auth_header from response, and use it to get broadcaster info
    .then(async function(response){
        const json=await response.json()
        auth_headers['Authorization']='Bearer '+config.access_token
        auth_headers['Client-Id']=json.client_id
        return fetch('https://api.twitch.tv/helix/users',{headers:auth_headers})
    })
    // store broadcaster info and set up IRC
    .then(async function(response){
        const json=await response.json()
        broadcaster=json.data[0]
        irc=new WebSocket('wss://irc-ws.chat.twitch.tv:443')
        irc.onopen=function(){
            IRCSend('PASS oauth:' + config.access_token)
            IRCSend('NICK ' + broadcaster.login)
            IRCSend('JOIN #' + broadcaster.login)
            IRCSend('CAP REQ :twitch.tv/tags')
        }
        irc.onerror=function(error){
            alert('Clippy lost connectuon to twitch, please reload: '+error)
            throw error
        }
        irc.onclose=irc.onerror
        irc.onmessage=function(event){
            console.debug('> '+event.data)
            for(const message of event.data.split('\r\n')){
                if(message==''){
                    continue
                }
                const [tags,prefix,data] = message.split(':')
                //console.debug(tags,prefix,data)
                if(tags=='PING '){
                    return IRCSend('PONG :'+prefix)
                }
                if('auto' in config && tags.includes('msg-id=raid')){
                    return shoutout(new URLSearchParams(tags.replaceAll(';',',')).get('msm-param-login'))
                }
                if(data==undefined){
                    continue
                }
                if('command' in config && config.commands.includes(data.split(' ')[0]) && ( tags.includes('badges=broadcaster') || tags.includes('mod=1'))){
                    const targets=data.split(' ')
                    targets.shift()
                    return shoutout(...targets)
                }
            }
        }
    })
    // get a new access token if previous steps fail
    .catch(function(error){
        alert('An error ocurred during clippy startup: '+error)
        if(!confirm('Would you like clippy to try getting a new access token? Choose Cancel/No if this message repeats itself, and make an issue report instead.')){
            throw error
        }
        const auth_url=new URL('https://id.twitch.tv/oauth2/authorize')
        auth_url.search=new URLSearchParams({
            'client_id':'72wtxvzs6erokrj33lk105whmoo381',
            'response_type':'token',
            'scope':'chat:read chat:edit moderation:read'
        }).toString()+'&redirect_uri=https://sugoidogo.github.io/js-util/auth-return.html'
        const url=new URL('https://sugoidogo.github.io/js-util/auth-return.html')
        url.search=new URLSearchParams({
            'redirect_uri':location.origin+location.pathname+location.search,
            'target':auth_url.href
        })
        location.assign(url)
    })

    if('assets' in config){
        for(let [name,url] of Object.entries(config.assets)){
            if(!url.startsWith('data:')){
                url=(await FileReaderAsync.readAs('DataURL',(await(await fetch(url)).blob())))
            }
            loadAsset(url,name).then(function(asset){
                if(asset instanceof HTMLScriptElement){
                    asset.type='module'
                }
                if(asset instanceof HTMLElement){
                    return body.appendChild(asset)
                }
                if(asset instanceof FontFace){
                    return document.fonts.add(asset)
                }
                return window[name]=asset
            })
        }
    }

    header.hidden=!'header' in config
    img.hidden=!'headerImg' in config
    footer.hidden=!'footer' in config

</script>