<!DOCTYPE html>
<body>
    <h1>Clippy</h1>
    <p>Use the controls below to change settings for your overlay.
    Press "Copy Overlay URL" <b>after</b> you change any settings,
    then paste into your browser source url.</p>
    <p id="login" hidden></p>
    <p id="pass" hidden></p>
    <div id="flex">
    <div id="settings">
    <input id="autoplay" type="checkbox">
    <label for="autoplay">Auto-play clips from my channel</label>
    <br>
    <input id="firstOn" type="checkbox" onchange="enabled('first',this.checked)">
    <label for="firstOn">Search the last </label>
    <input id="first" type="number" min="1" max="100" step="1" value="20" disabled>
    <label for="first"> clips</label>
    <br>
    <input id="noreplay" type="checkbox" checked>
    <label for="noreplay">Don't use clips already played this session</label>
    <br>
    <input id="samegame" type="checkbox">
    <label for="samegame">Find clips in my category</label>
    <br>
    <input id="lastgame" type="checkbox">
    <label for="lastgame">Find clips in the target's category</label>
    <br>
    <input id="durOn" type="checkbox" onclick="enabled('dur',this.checked)">
    <label for="durOn">Max clip duration in seconds: </label>
    <input id="dur" type="number" min="5" max="60" step="0.1" value="60" disabled>
    <br>
    <input id="views" type="checkbox">
    <label for="views">Most Viewed</label>
    <br>
    <input id="cutOn" type="checkbox" onclick="enabled('cut',this.checked)">
    <label for="cutOn">Clip cutoff in seconds: </label>
    <input id="cut" type="number" min="5" max="60" step="0.1" value="60" disabled>
    <br>
    <button onclick="copyURL()">Copy Overlay URL</button>
    </div>
    <div id="commands">
        <label for="header">Target Prefix:</label>
        <input type="text" id="header" value="Check out">
        <br>
        <label for="css">Custom CSS URI:</label>
        <input type="text" id="css" value="inline.css">
        <br>
        <input id='newCommand' type="text">
        <button onclick="addCommand()">Add Command</button>
        <p>Click on a command to remove it</p>
        <ul>
            <li><button class="command" onclick="removeCommand(this)">!so</button></li>
            <li><button class="command" onclick="removeCommand(this)">!shoutout</button></li>
        </ul>
    </div>
    </div>
</body>
<style>
    div {
        margin-right: 20px;
    }
    #flex {
        display:flex;
    }
</style>
<script>
    const client_id='72wtxvzs6erokrj33lk105whmoo381';
    const newCommandHTML='<li><button class="command" onclick="removeCommand(this)">!command</button></li>';
    const overlayURLBase=window.location.href.split('#')[0]+'overlay.html';
    const newCommand=document.getElementById('newCommand');
    const commands=document.getElementById('commands');
    const login=document.getElementById('login');
    const pass=document.getElementById('pass');
    const samegame=document.getElementById('samegame');
    const dur=document.getElementById('dur');
    const first=document.getElementById('first');
    const rand=document.getElementById('rand');
    const views=document.getElementById('views');
    const cut=document.getElementById('cut');
    const noreplay=document.getElementById('noreplay');
    const autoplay=document.getElementById('autoplay');
    const lastgame=document.getElementById('lastgame');
    const header=document.getElementById('header');

    function enabled(element,state){
        document.getElementById(element).disabled=!state;
    }

    async function getPass() {
        try {
            const pass = new URLSearchParams(document.location.hash.replace('#', '?')).get('access_token')
            if (!pass) {
                throw 'missing access token'
            }
            return pass;
        } catch (e) {
            window.location.href = encodeURI(
                'https://id.twitch.tv/oauth2/authorize'
                + '?response_type=token'
                + '&client_id='+client_id
                + '&scope=chat:read chat:edit'
            )+'&redirect_uri='+window.location.href.split('?')[0];
            throw e;
        }
    }

    async function getLogin(pass) {
        const response=await fetch('https://api.twitch.tv/helix/users'
            ,{
                headers:{
                    'Authorization':'Bearer '+pass
                    ,'Client-Id':client_id
                }
            }
        )
        const json=await response.json()
        return json['data'][0]['login'];
    }

    async function init(){
        pass.value=await getPass();
        login.value=await getLogin(pass.value);
    }

    async function removeCommand(element){
        element.parentElement.remove()
    }

    async function addCommand(){
        const commandName=newCommand.value;
        const commandHTML=newCommandHTML.replace('!command',commandName);
        commands.innerHTML+=commandHTML;
    }

    async function copyURL(){
        let url=new URL(overlayURLBase);
        let search=new URLSearchParams({
            client_id:client_id,
            login:login.value,
            pass:pass.value
        });
        let commands='';
        for (const button of document.getElementsByClassName('command')){
            commands+=button.innerHTML+','
        }
        search.append('commands',commands);
        if(samegame.checked){
            search.append('samegame','true');
        }
        if(!first.disabled){
            search.append('first',first.value);
        }
        if(!dur.disabled){
            search.append('dur',dur.value);
        }
        if(!cut.disabled){
            search.append('cut',cut.value);
        }
        if(views.checked){
            search.append('views','true');
        }
        if(noreplay.checked){
            search.append('noreplay','true');
        }
        if(autoplay.checked){
            search.append('autoplay','true');
        }
        if(lastgame.checked){
            search.append('lastgame','true');
        }
        if(css.value){
            search.append('css',css.value);
        }
        if(header.value){
            search.append('header',header.value);
        }
        url.search=search;
        navigator.clipboard.writeText(url);
    }

    init();

</script>
